<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>ADHD 闭环专注系统</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{background:#f5f7fa;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif}
    .timer{font-size:4rem;font-weight:700;color:#0d6efd;text-align:center;margin:1rem 0}
    .card{box-shadow:0 2px 8px rgba(0,0,0,.05);border:none}
    .lock-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);color:#fff;display:none;justify-content:center;align-items:center;flex-direction:column;z-index:1050}
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <span class="navbar-brand">ADHD 闭环专注系统</span>
    <a class="btn btn-outline-light btn-sm" href="/logout">退出</a>
  </div>
</nav>

<div class="container-fluid mt-4">
  <div class="row g-4">
    <!-- 任务 -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header d-flex justify-content-between">
          <span>今日任务</span>
          <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">+</button>
        </div>
        <ul id="taskList" class="list-group list-group-flush"></ul>
        <div class="card-footer text-center">
          <small class="text-muted">累计完成 <span id="doneCount">0</span> 个番茄</small>
        </div>
      </div>
    </div>

    <!-- 番茄钟 -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header text-center">番茄钟</div>
        <div class="card-body text-center">
          <div class="timer" id="timer">25:00</div>
          <button class="btn btn-success" id="startBtn">开始专注</button>
          <button class="btn btn-outline-secondary mt-2" id="resetBtn">重置</button>
        </div>
      </div>

      <!-- 图表 -->
      <div class="card mt-3">
        <div class="card-header">专注时长</div>
        <div class="card-body"><canvas id="focusChart" height="150"></canvas></div>
      </div>
    </div>

    <!-- 总结 & 留言 -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">每日总结</div>
        <div class="card-body">
          <textarea id="moodText" class="form-control mb-2" rows="3" placeholder="写下今天的心情..."></textarea>
          <button class="btn btn-primary w-100" id="saveMoodBtn">保存</button>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-header">匿名留言墙</div>
        <ul id="msgWall" class="list-group list-group-flush"></ul>
      </div>

      <div class="card mt-3">
        <div class="card-header">今日推荐</div>
        <ul id="recList" class="list-group list-group-flush"></ul>
      </div>
    </div>
  </div>
</div>

<!-- 专注锁定遮罩 -->
<div class="lock-overlay" id="lockOverlay">
  <h2>专注中...</h2>
  <p>请不要打开干扰应用</p>
  <button class="btn btn-danger mt-3" id="giveUpBtn">今日放弃（1/1）</button>
</div>

<!-- 新增任务模态框 -->
<div class="modal fade" id="addTaskModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">新增任务</div>
      <div class="modal-body">
        <input id="taskTitle" class="form-control mb-2" placeholder="任务标题">
        <input id="taskDur" type="number" class="form-control" placeholder="分钟" value="25" min="5" max="120">
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="addTaskConfirm">添加</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// 前端主逻辑
const api = {
  tasks: '/api/tasks',
  focus: '/api/focus',
  focusData: '/api/focus_data',
  mood: '/api/mood',
  messages: '/api/messages',
  recommend: '/api/recommend'
};

/* ========= 登录状态 ========= */
const userId = {{ session['user_id'] or 0 }};

/* ========= 任务 ========= */
async function loadTasks() {
  const res = await fetch(api.tasks);
  const tasks = await res.json();
  const list = document.getElementById('taskList');
  list.innerHTML = '';
  let done = 0;
  tasks.forEach(t => {
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between';
    li.innerHTML = `
      <span>${t.title} (${t.duration}min)</span>
      <button class="btn btn-sm ${t.finished?'btn-secondary':'btn-outline-success'}" 
              onclick="toggleTask(${t.id})">${t.finished?'已完成':'开始'}</button>`;
    list.appendChild(li);
    if (t.finished) done++;
  });
  document.getElementById('doneCount').textContent = done;
}
loadTasks();

async function toggleTask(id) {
  await fetch(`/api/finish_task/${id}`, {method:'POST'});
  loadTasks();
}

/* ========= 番茄钟 ========= */
let sec = 25 * 60, timer = null;
const timerEl = document.getElementById('timer');
function renderTimer() {
  const m = String(Math.floor(sec / 60)).padStart(2, '0');
  const s = String(sec % 60).padStart(2, '0');
  timerEl.textContent = `${m}:${s}`;
}
renderTimer();
document.getElementById('startBtn').onclick = () => {
  if (timer) return;
  timer = setInterval(() => {
    sec--;
    renderTimer();
    if (sec <= 0) {
      clearInterval(timer); timer = null;
      alert('专注完成！');
    }
  }, 1000);
};
document.getElementById('resetBtn').onclick = () => {
  clearInterval(timer); timer = null;
  sec = 25 * 60;
  renderTimer();
};

/* ========= 新增任务 ========= */
document.getElementById('addTaskConfirm').onclick = async () => {
  const title = document.getElementById('taskTitle').value.trim();
  const dur = +document.getElementById('taskDur').value;
  if (!title) return alert('请输入任务');
  await fetch(api.tasks, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({title, duration: dur})
  });
  bootstrap.Modal.getInstance(document.getElementById('addTaskModal')).hide();
  document.getElementById('taskTitle').value = '';
  loadTasks();
};

/* ========= 图表 ========= */
async function loadChart() {
  const res = await fetch(api.focusData);
  const data = await res.json();
  const labels = data.map(d => d.date);
  const values = data.map(d => d.minutes);
  new Chart(document.getElementById('focusChart'), {
    type: 'bar',
    data: {labels, datasets:[{label:'专注分钟', data:values, backgroundColor:'#0d6efd'}]},
    options: {scales:{y:{beginAtZero:true}}}
  });
}
loadChart();

/* ========= 留言 & 推荐 ========= */
(async () => {
  const msgs = await (await fetch(api.messages)).json();
  const wall = document.getElementById('msgWall');
  msgs.forEach(m=>{
    const li = document.createElement('li');
    li.className = 'list-group-item';
    li.textContent = m.text;
    wall.appendChild(li);
  });
  const recs = await (await fetch(api.recommend)).json();
  const recList = document.getElementById('recList');
  recs.forEach(r=>{
    const li = document.createElement('li');
    li.className = 'list-group-item';
    li.innerHTML = `<a href="${r.url}" target="_blank">${r.title}</a>`;
    recList.appendChild(li);
  });
})();

/* ========= 总结 ========= */
document.getElementById('saveMoodBtn').onclick = async () => {
  const text = document.getElementById('moodText').value.trim();
  if (!text) return;
  await fetch(api.mood, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({text})
  });
  document.getElementById('moodText').value = '';
  alert('已保存');
};
</script>
</body>
</html>
:root {
  --primary: #0d6efd;
  --secondary: #6c757d;
  --bg: #f5f7fa;
  --card-bg: #ffffff;
  --text: #212529;
}
body { background: var(--bg); color: var(--text); font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif; }
.navbar { background: linear-gradient(135deg, #0d6efd, #0a58ca); }
.timer { font-size: 4rem; font-weight: 700; color: var(--primary); text-align: center; margin: 1rem 0; }
.card { border: none; border-radius: 0.75rem; box-shadow: 0 2px 8px rgba(0,0,0,.05); background: var(--card-bg); }
.lock-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.8); color: #fff; display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 1050; }n: column; z-index: 1050; }
// 纯前端本地存储版本
const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
let doneCount = +localStorage.getItem('doneCount') || 0;

function loadTasks() {
  const list = document.getElementById('taskList');
  list.innerHTML = '';
  tasks.forEach((t, idx) => {
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between';
    li.innerHTML = `
      <span>${t.title} (${t.duration}min)</span>
      <button class="btn btn-sm ${t.done?'btn-secondary':'btn-outline-success'}" onclick="toggleTask(${idx})">${t.done?'已完成':'开始'}</button>`;
    list.appendChild(li);
  });
  document.getElementById('doneCount').textContent = doneCount;
}
loadTasks();

function toggleTask(idx) {
  if (tasks[idx].done) return;
  tasks[idx].done = true;
  doneCount++;
  localStorage.setItem('tasks', JSON.stringify(tasks));
  localStorage.setItem('doneCount', doneCount);
  loadTasks();
}

let sec = 25 * 60, timer = null;
const timerEl = document.getElementById('timer');
function renderTimer() {
  const m = String(Math.floor(sec / 60)).padStart(2, '0');
  const s = String(sec % 60).padStart(2, '0');
  timerEl.textContent = `${m}:${s}`;
}
renderTimer();

document.getElementById('startBtn').onclick = () => {
  if (timer) return;
  document.getElementById('lockOverlay').style.display = 'flex';
  timer = setInterval(() => {
    sec--;
    renderTimer();
    if (sec <= 0) {
      clearInterval(timer); timer = null;
      document.getElementById('lockOverlay').style.display = 'none';
      alert('专注完成！');
    }
  }, 1000);
};
document.getElementById('resetBtn').onclick = () => {
  clearInterval(timer); timer = null;
  sec = 25 * 60;
  renderTimer();
  document.getElementById('lockOverlay').style.display = 'none';
};
document.getElementById('giveUpBtn').onclick = () => {
  clearInterval(timer); timer = null;
  sec = 25 * 60;
  renderTimer();
  document.getElementById('lockOverlay').style.display = 'none';
};

document.getElementById('addTaskConfirm').onclick = () => {
  const title = document.getElementById('taskTitle').value.trim();
  const dur = +document.getElementById('taskDur').value;
  if (!title) return alert('请输入任务');
  tasks.push({ title, duration: dur, done: false });
  localStorage.setItem('tasks', JSON.stringify(tasks));
  bootstrap.Modal.getInstance(document.getElementById('addTaskModal')).hide();
  document.getElementById('taskTitle').value = '';
  loadTasks();
};

document.getElementById('saveMoodBtn').onclick = () => {
  const text = document.getElementById('moodText').value.trim();
  if (!text) return;
  const li = document.createElement('li');
  li.className = 'list-group-item';
  li.textContent = text;
  document.getElementById('msgWall').appendChild(li);
  document.getElementById('moodText').value = '';
};

// 推荐静态写死
const recs = [
  {title: "成人 ADHD 的 5 个时间管理技巧", url: "#"},
  {title: "2 分钟正念冥想练习", url: "#"}
];
recs.forEach(r=>{
  const li = document.createElement('li');
  li.className = 'list-group-item';
  li.innerHTML = `<a href="${r.url}" target="_blank">${r.title}</a>`;
  document.getElementById('recList').appendChild(li);
});
